<!DOCTYPE html>
<html lang="en">
<head>
<!--
TODO
add midday, sunshine, sunset, midnight written in inner circle
add settings: user can choose language; user can choose nonworking-day(s); user can define a number of alarms for daily routine on working and nonworking days.
add numeric time written
convert to widget
consistent dark color to system color
-->
  <meta charset="UTF-8" />
  <meta name="version" content="3.1" />
  <link rel="manifest" href="manifest.json" />
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Analog Clock</title>
  <meta name="theme-color" content="#121212" />

  <style>
    :root {
      --clock-size: 80vmin;
      --background-body: #000;
      --forecolor: #dca;
      --objects-border-color: black;
      --shadow-color: #0005;
      --dial-color-top: #632;
      --dial-color-bottom: #226;
      --hour-hand-color: #f0a500;
      --minute-hand-color: #bfb;
      --second-hand-color: #e65946;
      --center_dot-color: #59b;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      height: 100vh;
      background: var(--background-body);
      color: var(--forecolor);
      font-family: Arial, sans-serif;
    }

    .physical_obj {
      position: absolute;
      border: 0.1vmin solid var(--objects-border-color);
      box-shadow: 1px 1px 2px var(--shadow-color);
    }

    .clock24 {
      position: relative;
      width: var(--clock-size);
      height: var(--clock-size);
    }

   .dial {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 0.5vmin solid var(--forecolor);
      border-radius: 50%;
      background: linear-gradient(
        to bottom,
        var(--dial-color-top) 0%,
        var(--dial-color-top) 50%,
        var(--dial-color-bottom) 50%,
        var(--dial-color-bottom) 100%
      );
      box-shadow: inset 0 0 10px var(--shadow-color);
    }


    .dial.map-mode {
      background: #222;
    }

    .dial_ticks {
      position: absolute;
      width: 100%;
      height: 100%;
    }

    .world-map {
      position: absolute;
      width: 100%;
      height: 100%;
      top: -0%;
      left: -0%;
      background-image: url('north_map.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0;
      transition: opacity 1s ease;
      pointer-events: none;
    }

    .clock24.map-mode .world-map {
      opacity: 0.8;
    }

    .clock24.map-mode .dial_ticks,
    .clock24.map-mode .dial_number {
      opacity: 0.55;
    }

    .earth-shadow {
      position: absolute;
      width: 100%;
      height: 100%;
      top: -0%;
      left: -0%;
      background-image: url('earth_shadow.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: 0;
    }
    .clock24.map-mode .earth-shadow {
      opacity: 30%;
    }

    .tick {
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 0% 0%;
      border-radius: 0.2vmin;
      background: var(--forecolor);
      transform: translateX(-50%) rotate(var(--tick-angle, 0deg)) translateY(var(--tick-offset, 0%));
    }

    .tick.hour {
      --tick-offset: -40vmin;
      height: 14.5vmin;
      width: 0.4vmin;
    }

    .tick.minute {
      --tick-offset: -42vmin;
      height: 2vmin;
      width: 0.4vmin;
    }

    .dial_number {
      position: absolute;
      width: 100%;
      height: 100%;
      color: var(--forecolor);
      transition: opacity 0.5s ease;
    }

    .dial_number span {
      position: absolute;
      width: 4vmin;
      height: 4vmin;
      transform: translate(-50%, -50%);
      text-align: center;
      line-height: 4vmin;
      text-shadow: 2px 2px 4px var(--shadow-color);
    }

    .dial_number.hour {
      font-size: 5vmin;
      font-weight: bold;
    }
    .dial_number.hour span {
      --radius: 44vmin;
    }
    .dial_number.minute {
      font-size: 3vmin;
      font-weight: normal;
    }
    .dial_number.minute span {
      --radius: 59vmin;
    }

    .physical_obj.hand {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: 50% 100%;
      border-radius: 2vmin;
      z-index: 3;
      transform: translate(-50%, -100%);
    }

    .physical_obj.hand.hour {
      z-index: 5;
      width: 18vmin;
      height: 34vmin;
      opacity: 99%;
      box-shadow: 0 0 0 #ffff;
      border:0;
    }

    .physical_obj.hand.hour svg {
      width: 100%;
      height: 100%;
      display: block;
    }
    .hour-hand-shape {
      stroke-width: 5px;
      fill:transparent;
    }
    .hour-hand-shape.shadow{
      transform: translate(4px, 4px);
      stroke: #1113;
      stroke-width: 4px;
    }
    .hour-hand-shape.border{
      stroke: black;
      stroke-width: 7px;
    }

    .physical_obj.hand.minute {
      z-index: 4;
      height: 44vmin;
      width: 1.2vmin;
      background: var(--minute-hand-color);
    }

    .physical_obj.hand.second {
      z-index: 6;
      height: 47vmin;
      width: 0.5vmin;
      background: var(--second-hand-color);
    }

    .sun {
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 7;
      width: 7vmin;
      height: 7vmin;
      border-radius: 50%;
      background: var(--hour-hand-color);
      opacity: 0.6;
      box-shadow: 0 0 8px var(--hour-hand-color);
    }

    .clock24.map-mode .sun {
      opacity: 0;
    }

    .center_dot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      border-radius: 50%;
      width: 3.5vmin;
      height: 3.5vmin;
      background: var(--center_dot-color);
    }

    #digital_clock {
      display:flex;
      padding: 15vmin;
      gap: 10vmin;
      min-width: 30vmin;
      color: #fbfbfb;
      font-family: Arial, sans-serif;
      font-size: 20pt;
    }
  </style>
</head>

<body>
  <div class="clock24" 
       data-new-type="true" 
       data-classic24-hour-numbers="true" 
       data-only-even-numbers="false" 
       data-classic-minute-positioning="true"
       data-rotation-dir="natural"
       data-view-mode="clock">
    <div class="dial"></div>

    <div class="world-map"></div>
    <div class="dial_ticks"></div>
    <div class='earth-shadow'></div>
    <div alt="hour_numbers" class="dial_number hour"></div>
    <div alt="minute_numbers" class="dial_number minute"></div>

    <svg alt="hour_hand" class="physical_obj hand hour" viewBox="0 -20 72 320">
      <defs>
        <filter id="glow">
          <feGaussianBlur stdDeviation="2" result="blur"/>
          <feMerge>
            <feMergeNode in="blur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      <polygon class="hour-hand-shape shadow" points="34,320 68,39 34,0 0,39 34,320" />
      <polygon class="hour-hand-shape border" points="34,320 68,39 34,0 0,39 34,320"/>  
      <polygon class="hour-hand-shape" points="34,330 68,39 34,0 34,60 34,-20 34,0 0,39 34,320" stroke="var(--hour-hand-color)"/>
      <circle class="sun" cx="72" cy="100" r="27" fill="var(--hour-hand-color)" 
              filter="url(#glow)" opacity="0.6"/>
    </svg>
    <div alt="minute_hand" class="physical_obj hand minute"></div>
    <div alt="second_hand" class="physical_obj hand second"></div>

    <div class="physical_obj center_dot"></div>
  </div>
    <div id='digital_clock'>--:--:--</div>

  <script>
    function createDialTicksAndNumbers(clock) {
      const dial_ticks = clock.querySelector('.dial_ticks');
      const hourNumbers = clock.querySelector('.dial_number.hour');
      const minuteNumbers = clock.querySelector('.dial_number.minute');
      
      const onlyEvenNumbers = clock.dataset.onlyEvenNumbers === "true";
      const newType = clock.dataset.newType === "true";
      const classic24HourNumbers = clock.dataset.classic24HourNumbers === "true";
      const classicMinutePositioning = clock.dataset.classicMinutePositioning === "true";

      // Create ticks once using CSS custom properties
      dial_ticks.innerHTML = '';
      for (let i = 0; i < 24; i++) {
        const tick = document.createElement('div');
        tick.className = 'tick hour';
        tick.style.setProperty('--tick-angle', `${i * 360/24}deg`);
        dial_ticks.appendChild(tick);
      }
      for (let i = 0; i < 60; i++) {
        const tick = document.createElement('div');
        tick.className = 'tick minute';
        tick.style.setProperty('--tick-angle', `${i * 360/60}deg`);
        dial_ticks.appendChild(tick);
      }

      // Create hour numbers once
      hourNumbers.innerHTML = '';
      for (let i = 0; i < 24; i++) {
        if (!onlyEvenNumbers || i % 2 === 0) {
          const span = document.createElement('span');
          const angle = newType ? -(i - 6 + 0.5) * 15 : i * 15;
          let hourNumber = classic24HourNumbers ? ((i + 6 - 1) % 12) + 1 : i % 24;
          
          const radius = 44;
          const rad = (angle - 90) * Math.PI / 180;
          const x = 50 + radius * Math.cos(rad);
          const y = 50 + radius * Math.sin(rad);
          
          span.style.left = `${x}%`;
          span.style.top = `${y}%`;
          span.textContent = hourNumber;
          hourNumbers.appendChild(span);
        }
      }

      // Create minute numbers once
      minuteNumbers.innerHTML = '';
      for (let i = 0; i < 60; i += 5) {
        const span = document.createElement('span');
        let angle = i * 6;
        if (classicMinutePositioning) angle -= 90;
        const rad = (180 - angle) * Math.PI / 180;
        const radius = 59;
        const x = 50 + radius * Math.cos(rad);
        const y = 50 + radius * Math.sin(rad);
        
        span.style.left = `${x}%`;
        span.style.top = `${y}%`;
        span.textContent = i === 0 ? '0' : i;
        minuteNumbers.appendChild(span);
      }
    }

    function calculateTimezoneRotation() {
      const now = new Date();
      // Get current timezone offset in hours (including DST)
      const timezoneOffset = -now.getTimezoneOffset() / 60;
      // Calculate rotation: GMT+0 = 0°, GMT+12 = 180°, GMT-12 = -180°
      let hour = now.getHours() + now.getMinutes() / 60;
      const rotation = (timezoneOffset - hour) / 24 * 360;
      return rotation;
    }

    function updateWorldMapRotation(clock) {
      const worldMap = clock.querySelector('.world-map');
      const rotation = calculateTimezoneRotation();
      worldMap.style.transform = `rotate(${rotation}deg)`;
    }

    function motorRotate(clock) {
      const hourHand = clock.querySelector('.hand.hour');
      const minuteHand = clock.querySelector('.hand.minute');
      const secondHand = clock.querySelector('.hand.second');

      const timezone = clock.dataset.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const now = new Date(new Date().toLocaleString("en-US", {timeZone: timezone}));
      const newType = clock.dataset.newType === "true";
      const classicMinutePositioning = clock.dataset.classicMinutePositioning === "true";

      let hour = now.getHours();
      let minute = now.getMinutes();
      let second = now.getSeconds();

      document.querySelector('#digital_clock').innerHTML = `${hour}:${minute}:${second}`;

      if (newType) {
        hour = (hour - 6 + 24) % 24;
      }

      let hourDeg = (hour + minute / 60) * 15;
      let minuteDeg = minute * 6;
      let secondDeg = second * 6;

      if (newType) {
        hourDeg = -hourDeg + 90;
        minuteDeg = -minuteDeg - 90;
        secondDeg = -secondDeg - 90;
      }

      if (classicMinutePositioning) {
        minuteDeg += 90;
        secondDeg += 90;
      }

      hourHand.style.transform = `translate(-50%, -100%) rotate(${hourDeg}deg)`;
      minuteHand.style.transform = `translate(-50%, -100%) rotate(${minuteDeg}deg)`;
      secondHand.style.transform = `translate(-50%, -100%) rotate(${secondDeg}deg)`;

      // Update world map rotation if in map mode
      if (clock.dataset.viewMode === 'map') {
        updateWorldMapRotation(clock);
      }
    }

    function toggleViewMode(clock) {
      const currentMode = clock.dataset.viewMode;
      const newMode = currentMode === 'clock' ? 'map' : 'clock';
      
      clock.dataset.viewMode = newMode;
      
      if (newMode === 'map') {
        clock.classList.add('map-mode');
        updateWorldMapRotation(clock);
      } else {
        clock.classList.remove('map-mode');
      }
    }

    navigator.serviceWorker.addEventListener('message', (event) => {
      if (event.data.type === 'UPDATE_AVAILABLE') {
        alert(event.data.message); // or show toast
        // Optionally reload: window.location.reload();
      }
    });
    
    // Initialize once on load
    document.querySelectorAll('.clock24').forEach(clock => {
      createDialTicksAndNumbers(clock);
      motorRotate(clock);
      
      // Add click event listener
      clock.addEventListener('click', () => {
        toggleViewMode(clock);
      });
    });

    // Update hands only every second
    setInterval(() => {
      document.querySelectorAll('.clock24').forEach(motorRotate);
    }, 1000);
  </script>
</body>
</html>